<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Padauk', sans-serif; background-color: #f4f6f9; }
        .login-container { max-width: 400px; margin: 80px auto; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .main-content { display: none; padding: 20px; }
        .profile-img-small { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        .details-img { width: 140px; height: 140px; object-fit: cover; border-radius: 50%; border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .search-box { position: relative; }
        .search-box input { border-radius: 20px; padding-left: 35px; }
        .search-box i { position: absolute; left: 15px; top: 10px; color: #aaa; }
        #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:none; justify-content:center; align-items:center; }
        
        .offcanvas { width: 280px !important; }
        .sidebar-header-text { font-size: 0.75rem; font-weight: 700; color: #adb5bd; letter-spacing: 1px; padding: 15px 15px 5px 15px; }
        .sidebar-item { cursor: pointer; transition: 0.2s; border: none; padding: 12px 20px; font-size: 15px; color: #495057; background: transparent; display: block; text-decoration: none; }
        .sidebar-item:hover { background-color: #f1f3f5; color: #0d6efd; padding-left: 25px; }
        .sidebar-item i { width: 25px; text-align: center; margin-right: 10px; }
        
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .page-input-box { width: 50px; text-align: center; border: 1px solid #dee2e6; color: #0d6efd; font-weight: 340; padding: 0.14rem 0.4rem; line-height: 1; outline: none; background: #fff; border-radius: 0; display: block; height: 100%; }
        .page-input-box:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); z-index: 2; position: relative; }
        .pagination .page-item:first-child .page-link { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .pagination .page-item:last-child .page-link { border-top-left-radius: 0; border-bottom-left-radius: 0; }
        .pagination .page-item + .page-item .page-input-box { margin-left: -1px; }
        .pagination .page-item + .page-item .page-link { margin-left: -1px; }

        .edu-row { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 5px; border: 1px solid #eee; }
        .file-link-badge { font-size: 0.8rem; margin-right: 5px; display: inline-block; margin-top: 2px; }
        .delete-file-btn { font-size: 0.7rem; margin-left: 5px; cursor: pointer; color: #dc3545; }
    </style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner-border text-primary" role="status"></div></div>

<!-- Login -->
<div class="container" id="loginSection">
    <div class="login-container">
        <h3 class="text-center text-primary fw-bold mb-4">HR System Login</h3>
        <form id="loginForm">
            <div class="mb-3"><label>Username</label><input type="text" class="form-control" id="username" required></div>
            <div class="mb-3"><label>Password</label><input type="password" class="form-control" id="password" required></div>
            <button type="submit" class="btn btn-primary w-100">Sign In</button>
        </form>
    </div>
</div>

<!-- Dashboard -->
<div class="container-fluid main-content" id="dashboardSection">
    <nav class="navbar navbar-light bg-white rounded shadow-sm mb-4 p-3 d-flex justify-content-between">
        <div class="d-flex align-items-center">
            <button class="btn btn-outline-primary me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu"><i class="fas fa-bars"></i> Manage</button>
            <span class="navbar-brand fw-bold text-primary m-0"><i class="fas fa-users-cog"></i> Employee System</span>
        </div>
        <div class="d-flex align-items-center">
            <span class="me-3 fw-bold text-secondary d-none d-md-block" id="userDisplay"></span>
            <button class="btn btn-outline-success btn-sm me-2" onclick="refreshData()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
            <button class="btn btn-outline-danger btn-sm" onclick="location.reload()" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
        <div class="offcanvas-header bg-primary text-white">
            <h5 class="offcanvas-title fw-bold"><i class="fas fa-cogs"></i> Management</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <div class="list-group list-group-flush" id="sidebarList"></div>
            <div class="p-3 mt-auto text-muted small border-top">Version 2.7 (Doc PDF)</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="card p-4 border-0 shadow-sm">
        <div class="d-flex justify-content-between flex-wrap gap-3 mb-4">
            <div><button class="btn btn-success" id="btnAdd" onclick="openModal('add')" style="display:none;"><i class="fas fa-plus"></i> Add Employee</button></div>
            <div class="d-flex gap-2">
                <select class="form-select w-auto" id="rowsPerPage" onchange="changeRowsPerPage()"><option value="10">10</option><option value="25">25</option><option value="50">50</option></select>
                <div class="search-box"><i class="fas fa-search"></i><input type="text" class="form-control" id="searchInput" placeholder="Search..." onkeyup="filterData()"></div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="bg-light"><tr><th>Photo</th><th>Sr</th><th>Name</th><th>Position</th><th>Department</th><th>Phone</th><th>Actions</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between mt-3">
            <span id="pageInfo" class="text-muted small"></span>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </div>
    </div>
</div>

<!-- Employee Modal -->
<div class="modal fade" id="employeeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Employee Form</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="employeeForm">
                    <input type="hidden" id="editRowIndex">
                    <input type="hidden" id="currentImage">
                    <ul class="nav nav-tabs mb-3" id="empTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-basic" type="button">Basic Info</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-edu" type="button">Education & Files</button></li>
                    </ul>
                    <div class="tab-content">
                        <!-- BASIC INFO TAB -->
                        <div class="tab-pane fade show active" id="tab-basic">
                            <div class="row g-3">
                                <div class="col-12 text-center mb-3">
                                    <img id="imgPreview" src="" class="details-img" style="display:none; margin: 0 auto 10px auto;">
                                    <div><label class="btn btn-outline-primary btn-sm"><i class="fas fa-camera"></i> Photo<input type="file" id="empPic" accept="image/*" hidden onchange="previewAndCompress(this)"></label><button type="button" class="btn btn-outline-danger btn-sm" id="btnDeleteImg" onclick="markImageForDeletion()" style="display:none;">Remove</button></div>
                                </div>
                                <div class="col-md-6"><label>Name</label><input type="text" class="form-control" id="empName" required></div>
                                <div class="col-md-6"><label>Position</label><select class="form-select" id="empPos"><option value="">Loading...</option></select></div>
                                <div class="col-md-6"><label>Department</label><select class="form-select" id="empDept"><option value="">Loading...</option></select></div>
                                <div class="col-md-6"><label>Blood Type</label><select class="form-select" id="empBlood"><option value="">Loading...</option></select></div>
                                
                                <div class="col-md-6"><label>Race</label><input type="text" class="form-control" id="empRace"></div>
                                <div class="col-md-6"><label>Religion</label><select class="form-select" id="empReligion"><option value="">Loading...</option></select></div>
                                
                                <div class="col-md-6"><label>Phone</label><input type="text" class="form-control" id="empPhone"></div>
                                <div class="col-md-6"><label>Email</label><input type="email" class="form-control" id="empEmail"></div>
                                <div class="col-md-6"><label>NRC No.</label><input type="text" class="form-control" id="empNrc"></div>
                                <div class="col-md-6"><label>Father Name</label><input type="text" class="form-control" id="empFather"></div>
                                <div class="col-md-6"><label>Mother Name</label><input type="text" class="form-control" id="empMother"></div>
                                <div class="col-md-6"><label>Start Date</label><input type="date" class="form-control" id="empStart"></div>
                                <div class="col-md-6"><label>Resign Date</label><input type="date" class="form-control" id="empResign"></div>
                                <div class="col-12"><label>Address</label><textarea class="form-control" id="empAddr" rows="2"></textarea></div>
                            </div>
                        </div>
                        <!-- EDUCATION TAB -->
                        <div class="tab-pane fade" id="tab-edu">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="fw-bold">Degrees / Certificates</label>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEduRow()"><i class="fas fa-plus"></i> Add Row</button>
                            </div>
                            <div id="eduContainer">
                                <!-- Dynamic Rows will appear here -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" onclick="saveEmployee()">Save Changes</button></div>
        </div>
    </div>
</div>

<!-- Settings & Report Modals -->
<div class="modal fade" id="settingsModal" tabindex="-1" style="z-index: 1060;"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">Manage Dropdowns</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="fw-bold">Select Category:</label><select class="form-select" id="settingsCategory" onchange="renderSettingsList()"><option value="Department">Department</option><option value="Position">Position</option><option value="Blood Type">Blood Type</option><option value="Religion">Religion</option></select></div><div class="input-group mb-3"><input type="text" class="form-control" id="newItemName" placeholder="New Item Name"><button class="btn btn-primary" onclick="addDropdownItem()">Add</button></div><h6 class="text-muted">Current Items:</h6><div class="list-group" id="settingsList" style="max-height: 250px; overflow-y: auto;"></div></div></div></div></div>
<div class="modal fade" id="reportModal" tabindex="-1" style="z-index: 1060;"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-info text-white"><h5 class="modal-title">Summary Dashboard</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row mb-4"><div class="col-md-12"><div class="card bg-light border-0 p-3 text-center"><h3 class="display-6 fw-bold text-primary" id="totalEmpCount">0</h3><span class="text-muted">Total Employees</span></div></div></div><div class="row"><div class="col-md-6"><h6 class="fw-bold border-bottom pb-2">By Department</h6><ul class="list-group list-group-flush" id="deptReportList"></ul></div><div class="col-md-6"><h6 class="fw-bold border-bottom pb-2">By Position</h6><ul class="list-group list-group-flush" id="posReportList"></ul></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>

<!-- View Details Modal (UPDATED BUTTON) -->
<div class="modal fade" id="viewModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-body" id="viewDetailsBody"></div><div class="modal-footer p-1">
    <!-- Server Side PDF Button (Dark with Red Icon) -->
    <button type="button" class="btn btn-dark btn-sm me-auto" onclick="generateAndDownloadPDF()"><i class="fas fa-file-pdf text-danger"></i> Export</button>
    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
</div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxVLV_0BrV4RfsVi8IPW9U3KzVOuya61WJtFVgLZvEdjBkgTpjQRJy3P5qu7y7-wt8guQ/exec"; // *** URL ထည့်ပါ ***
    let currentUser = { role: null, username: null, department: null };
    let allData = [], filteredData = [], currentPage = 1, rowsPerPage = 10;
    let dropdownData = { "Department": [], "Position": [], "Blood Type": [], "Religion": [] }; 
    let compressedImageBase64 = null, deleteImageFlag = false;
    let eduFilesToDelete = []; 
    let currentViewedEmp = null;

    // Login
    document.getElementById('loginForm').addEventListener('submit', function(e) { e.preventDefault(); showLoading(true); fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'login', username: document.getElementById('username').value, password: document.getElementById('password').value }) }).then(res => res.json()).then(data => { showLoading(false); if(data.status === 'success') { currentUser = { role: data.role, username: document.getElementById('username').value, department: data.department }; initDashboard(); } else Swal.fire('Error', data.message, 'error'); }).catch(e => { showLoading(false); alert('Error: ' + e); }); });

    function initDashboard() {
        document.getElementById('loginSection').style.display = 'none'; document.getElementById('dashboardSection').style.display = 'block'; document.getElementById('userDisplay').innerText = `${currentUser.username} (${currentUser.role})`;
        const sidebarList = document.getElementById('sidebarList');
        let sidebarHTML = '';
        if(currentUser.role === 'Root') {
            document.getElementById('btnAdd').style.display = 'inline-block';
            sidebarHTML = `<div class="sidebar-header-text">ADMINISTRATION</div><a class="list-group-item sidebar-item" onclick="openSettingsModal()"><i class="fas fa-list-alt text-primary"></i> Manage Dropdowns</a><div class="sidebar-header-text mt-2">REPORTS</div><a class="list-group-item sidebar-item" onclick="openReportModal()"><i class="fas fa-chart-pie text-info"></i> Summary Dashboard</a><a class="list-group-item sidebar-item" onclick="exportToExcel()"><i class="fas fa-file-excel text-success"></i> Export to Excel</a>`;
        } else {
            document.getElementById('btnAdd').style.display = 'none';
            sidebarHTML = `<div class="sidebar-header-text mt-2">REPORTS</div><a class="list-group-item sidebar-item" onclick="openReportModal()"><i class="fas fa-chart-pie text-info"></i> Summary Dashboard</a>`;
        }
        sidebarList.innerHTML = sidebarHTML; loadEmployees(); loadAllDropdowns();
    }

    function refreshData() { loadEmployees(); loadAllDropdowns(); }

    function addEduRow(title = "", urls = "") {
        const container = document.getElementById('eduContainer');
        const div = document.createElement('div');
        div.className = 'edu-row row g-2 align-items-center';
        
        let fileDisplay = "";
        let urlList = [];
        if(Array.isArray(urls)) { urlList = urls; } 
        else if (typeof urls === 'string' && urls.trim() !== "") {
            try { if (urls.startsWith('[')) urlList = JSON.parse(urls); else urlList = urls.split(" || "); } catch(e) { urlList = [urls]; }
        }

        urlList.forEach((link, idx) => {
            if(link.trim()) {
                fileDisplay += `
                    <span class="badge bg-success text-decoration-none me-1 mb-1 file-link-badge">
                        File ${idx+1} <a href="${link}" target="_blank" class="text-white"><i class="fas fa-download"></i></a>
                        <i class="fas fa-times-circle delete-file-btn" onclick="markFileForDelete(this, '${link}')"></i>
                    </span>`;
            }
        });

        div.innerHTML = `<div class="col-5"><input type="text" class="form-control form-control-sm edu-title" placeholder="Certificate Name" value="${title}"></div><div class="col-6"><input type="file" class="form-control form-control-sm edu-file" accept=".pdf,.jpg,.jpeg,.png" multiple><div class="mt-1" id="fileList">${fileDisplay}</div><input type="hidden" class="edu-existing-urls" value='${JSON.stringify(urlList)}'></div><div class="col-1 text-end"><button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="removeEduRow(this)"><i class="fas fa-times"></i></button></div>`;
        container.appendChild(div);
    }

    window.markFileForDelete = function(element, urlToRemove) {
        if(confirm("Remove this file?")) {
            eduFilesToDelete.push(urlToRemove);
            const badgeSpan = element.closest('.file-link-badge');
            const fileContainer = badgeSpan.parentElement; 
            badgeSpan.remove();
            
            const row = fileContainer.closest('.col-6');
            const hiddenInput = row.querySelector('.edu-existing-urls');
            let currentUrls = JSON.parse(hiddenInput.value || "[]");
            currentUrls = currentUrls.filter(u => u !== urlToRemove);
            hiddenInput.value = JSON.stringify(currentUrls);
        }
    }

    window.removeEduRow = function(btn) {
        const row = btn.closest('.edu-row');
        const hiddenInput = row.querySelector('.edu-existing-urls');
        const urls = JSON.parse(hiddenInput.value || "[]");
        if (urls.length > 0) { urls.forEach(url => eduFilesToDelete.push(url)); }
        row.remove();
    }

        window.viewDetails = function(rowIndex) { 
        const emp = allData.find(r => r.row_index === rowIndex);
        // Prepare Object for Server-side PDF
        currentViewedEmp = {
            Name: emp.Name, Position: emp.Position, Department: emp.Department, Phone: emp.Phone, Email: emp.Email,
            Address: emp.Address, Nrc: emp['NRC No.'], FatherName: emp['Father Name'], MotherName: emp['Mother Name'],
            BloodType: emp['Blood Type'], Race: emp.Race, Religion: emp.Religion, StartDate: emp['Start Date'], ResignDate: emp['Resign Date'],
            ProfilePic: emp['Profile Pic'], EducationObject: emp.EducationObject
        };

        // --- NEW LOGIC: PDF Button Permission Check ---
        const pdfBtn = document.querySelector('#viewModal .btn-dark'); // Export Button
        
        // Default State: Enable Button
        pdfBtn.disabled = false;
        pdfBtn.innerHTML = '<i class="fas fa-file-pdf text-danger"></i> Export';

        // Check Logic: If Admin AND Departments don't match -> Lock Button
        if (currentUser.role === 'Admin') {
            const userDept = (currentUser.department || "").trim();
            const empDept = (emp.Department || "").trim();

            if (userDept !== empDept) {
                pdfBtn.disabled = true;
                pdfBtn.innerHTML = '<i class="fas fa-lock"></i> Restricted';
            }
        }
        // ----------------------------------------------

        let pic = emp['Profile Pic'] ? `<img src="${emp['Profile Pic']}" class="details-img">` : `<div class="details-img d-flex align-items-center justify-content-center bg-secondary text-white mx-auto"><i class="fas fa-user fa-3x"></i></div>`; 
        let eduHtml = '<p class="text-muted small">No education info</p>';
        
        if(emp.EducationObject && emp.EducationObject.length > 0) {
            eduHtml = '<ul class="list-group list-group-flush text-start">';
            emp.EducationObject.forEach(item => {
                let linksHtml = '';
                let urlArray = Array.isArray(item.urls) ? item.urls : [];
                urlArray.forEach((link, idx) => {
                    if(link.trim()) {
                        // Education File Permission Logic (Existing)
                        if (currentUser.role === 'Root') { linksHtml += `<a href="${link}" target="_blank" class="badge bg-primary text-decoration-none ms-1">File ${idx+1}</a>`; } 
                        else { linksHtml += `<span class="badge bg-secondary ms-1"><i class="fas fa-lock"></i></span>`; } 
                    }
                });
                eduHtml += `<li class="list-group-item py-1 px-0 d-flex justify-content-between align-items-center"><span>${item.title}</span> <div>${linksHtml}</div></li>`;
            });
            eduHtml += '</ul>';
        }
        const formatDate = (dateStr) => { if (!dateStr) return '-'; const d = new Date(dateStr); return isNaN(d.getTime()) ? dateStr : d.toISOString().split('T')[0]; };
        
        document.getElementById('viewDetailsBody').innerHTML = `
            <div class="text-center">${pic} <h4 class="fw-bold">${emp.Name}</h4><div class="mb-3"><span class="badge bg-secondary">${emp.Position || 'No Pos'}</span> | <span class="badge bg-primary">${emp.Department || 'No Dept'}</span></div></div>
            <ul class="nav nav-tabs mb-2" id="viewTabs" role="tablist"><li class="nav-item"><button class="nav-link active py-1" data-bs-toggle="tab" data-bs-target="#view-basic" type="button">Info</button></li><li class="nav-item"><button class="nav-link py-1" data-bs-toggle="tab" data-bs-target="#view-edu" type="button">Education</button></li></ul>
            <div class="tab-content text-start">
                <div class="tab-pane fade show active" id="view-basic">
                    <table class="table table-bordered table-sm mb-0">
                        <tr><th width="35%">Sr No.</th><td>${emp['Sr No.']}</td></tr>
                        <tr><th>NRC No.</th><td>${emp['NRC No.'] || '-'}</td></tr>
                        <tr><th>Religion</th><td>${emp.Religion || '-'}</td></tr>
                        <tr><th>Race</th><td>${emp.Race || '-'}</td></tr>
                        <tr><th>Father Name</th><td>${emp['Father Name'] || '-'}</td></tr>
                        <tr><th>Mother Name</th><td>${emp['Mother Name'] || '-'}</td></tr>
                        <tr><th>Blood Type</th><td>${emp['Blood Type'] || '-'}</td></tr>
                        <tr><th>Phone</th><td>${emp.Phone || '-'}</td></tr>
                        <tr><th>Email</th><td>${emp.Email || '-'}</td></tr><tr><th>Address</th><td>${emp.Address || '-'}</td></tr>
                        <tr><th>Start Date</th><td>${formatDate(emp['Start Date'])}</td></tr><tr><th>Resign Date</th><td>${formatDate(emp['Resign Date'])}</td></tr>
                    </table>
                </div>
                <div class="tab-pane fade" id="view-edu">${eduHtml}</div>
            </div>`; 
        new bootstrap.Modal(document.getElementById('viewModal')).show(); 
    }


    // --- GENERATE PDF via BACKEND (DOC TEMPLATE) ---
    function generateAndDownloadPDF() {
        if (!currentViewedEmp) return;
        const btn = document.querySelector('#viewModal .btn-dark'); 
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        btn.disabled = true;

        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'generateProfilePDF', 
                employeeData: currentViewedEmp 
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                const byteCharacters = atob(data.pdfBase64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], {type: "application/pdf"});
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = data.fileName;
                link.click();
            } else {
                alert("PDF Error: " + data.message);
            }
        })
        .catch(err => alert("Connection Error: " + err))
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }

    // --- MAIN CRUD ---
    window.openModal = function(mode, rowIndex = null) { 
        const modal = new bootstrap.Modal(document.getElementById('employeeModal')); 
        document.getElementById('employeeForm').reset(); 
        document.getElementById('eduContainer').innerHTML = ''; 
        compressedImageBase64 = null; deleteImageFlag = false; eduFilesToDelete = []; 
        document.getElementById('imgPreview').style.display = 'none'; document.getElementById('btnDeleteImg').style.display = 'none'; 
        var firstTabEl = document.querySelector('#empTabs button[data-bs-target="#tab-basic"]'); var firstTab = new bootstrap.Tab(firstTabEl); firstTab.show();

        if(mode === 'edit') { 
            const emp = allData.find(r => r.row_index === rowIndex); 
            document.getElementById('modalTitle').innerText = "Edit Employee"; document.getElementById('editRowIndex').value = rowIndex; document.getElementById('currentImage').value = emp['Profile Pic']; 
            document.getElementById('empName').value = emp.Name; document.getElementById('empDept').value = emp.Department || ""; document.getElementById('empPos').value = emp.Position || ""; document.getElementById('empBlood').value = emp['Blood Type'] || ""; document.getElementById('empRace').value = emp.Race || ""; document.getElementById('empReligion').value = emp.Religion || ""; document.getElementById('empPhone').value = emp.Phone; document.getElementById('empEmail').value = emp.Email; document.getElementById('empNrc').value = emp['NRC No.']; document.getElementById('empFather').value = emp['Father Name']; document.getElementById('empMother').value = emp['Mother Name']; document.getElementById('empAddr').value = emp.Address;
            if(emp['Start Date']) document.getElementById('empStart').value = new Date(emp['Start Date']).toISOString().split('T')[0]; if(emp['Resign Date']) document.getElementById('empResign').value = new Date(emp['Resign Date']).toISOString().split('T')[0]; 
            if (emp['Profile Pic']) { document.getElementById('imgPreview').src = emp['Profile Pic']; document.getElementById('imgPreview').style.display = 'block'; document.getElementById('btnDeleteImg').style.display = 'inline-block'; }
            
            if(emp.EducationObject && emp.EducationObject.length > 0) {
                emp.EducationObject.forEach(item => addEduRow(item.title, item.urls));
            }
        } else { 
            document.getElementById('modalTitle').innerText = "Add New Employee"; document.getElementById('editRowIndex').value = ""; 
            addEduRow(); 
        } 
        modal.show(); 
    }

    window.saveEmployee = async function() {
        showLoading(true);
        const rowIndex = document.getElementById('editRowIndex').value;
        const eduRows = document.querySelectorAll('.edu-row');
        const educationData = [];
        
        for (const row of eduRows) {
            const title = row.querySelector('.edu-title').value.trim();
            if(!title) continue; 
            
            const fileInput = row.querySelector('.edu-file');
            const hiddenInput = row.querySelector('.edu-existing-urls');
            const existingUrls = JSON.parse(hiddenInput.value || "[]");
            let filesBase64 = [];

            if (fileInput.files.length > 0) {
                for (let i = 0; i < fileInput.files.length; i++) {
                    let b64 = await toBase64(fileInput.files[i]);
                    filesBase64.push(b64);
                }
            }
            
            educationData.push({ 
                title: title, 
                files_base64: filesBase64, 
                existingUrls: existingUrls 
            });
        }

        const employeeData = { 
            Name: document.getElementById('empName').value, Department: document.getElementById('empDept').value, Position: document.getElementById('empPos').value, BloodType: document.getElementById('empBlood').value, Race: document.getElementById('empRace').value, Religion: document.getElementById('empReligion').value, Nrc: document.getElementById('empNrc').value, Phone: document.getElementById('empPhone').value, Email: document.getElementById('empEmail').value, Address: document.getElementById('empAddr').value, FatherName: document.getElementById('empFather').value, MotherName: document.getElementById('empMother').value, StartDate: document.getElementById('empStart').value, ResignDate: document.getElementById('empResign').value, image_base64: compressedImageBase64, current_image: document.getElementById('currentImage').value,
            Education: educationData 
        };
        const payload = { action: rowIndex ? 'editEmployee' : 'addEmployee', employee: employeeData, rowIndex: rowIndex ? parseInt(rowIndex) : null, deleteImageFlag: deleteImageFlag, deleted_edu_files: eduFilesToDelete }; 
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) }).then(res => res.json()).then(data => { showLoading(false); bootstrap.Modal.getInstance(document.getElementById('employeeModal')).hide(); Swal.fire('Success', data.message, 'success'); loadEmployees(); });
    }

    // --- GLOBALS ---
    window.exportToExcel = function() { const wb = XLSX.utils.book_new(); const cleanData = allData.map(item => { const { row_index, EducationObject, "Edu Links": eduLinks, ...rest } = item; return rest; }); const ws = XLSX.utils.json_to_sheet(cleanData); XLSX.utils.book_append_sheet(wb, ws, "Employees"); XLSX.writeFile(wb, "Employees_Report.xlsx"); }
    window.openSettingsModal = function() { const sidebarEl = document.getElementById('sidebarMenu'); const sidebarInstance = bootstrap.Offcanvas.getInstance(sidebarEl); if(sidebarInstance) sidebarInstance.hide(); renderSettingsList(); new bootstrap.Modal(document.getElementById('settingsModal')).show(); }
    window.renderSettingsList = function() { const category = document.getElementById('settingsCategory').value; const listContainer = document.getElementById('settingsList'); const items = dropdownData[category] || []; listContainer.innerHTML = ''; if(items.length === 0) { listContainer.innerHTML = '<div class="p-3 text-center text-muted">No items found.</div>'; return; } items.forEach(item => { listContainer.innerHTML += `<div class="list-group-item d-flex justify-content-between align-items-center"><span>${item}</span><button class="btn btn-sm btn-outline-danger" onclick="deleteDropdownItem('${category}', '${item}')"><i class="fas fa-trash"></i></button></div>`; }); }
    window.addDropdownItem = function() { const category = document.getElementById('settingsCategory').value; const value = document.getElementById('newItemName').value.trim(); if(!value) return; showLoading(true); fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'addDropdownItem', category: category, value: value }) }).then(res => res.json()).then(resp => { showLoading(false); if(resp.status === 'success') { document.getElementById('newItemName').value = ''; fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getAllDropdowns' }) }).then(r => r.json()).then(d => { dropdownData = d.data; renderSettingsList(); populateSelects(); }); } }); }
    window.deleteDropdownItem = function(category, value) { if(!confirm(`Delete "${value}"?`)) return; showLoading(true); fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteDropdownItem', category: category, value: value }) }).then(res => res.json()).then(resp => { showLoading(false); fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getAllDropdowns' }) }).then(r => r.json()).then(d => { dropdownData = d.data; renderSettingsList(); populateSelects(); }); }); }
    window.previewAndCompress = function(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.src = e.target.result; img.onload = function() { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_SIZE = 800; let width = img.width, height = img.height; if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); compressedImageBase64 = canvas.toDataURL('image/jpeg', 0.7); document.getElementById('imgPreview').src = compressedImageBase64; document.getElementById('imgPreview').style.display = 'block'; document.getElementById('btnDeleteImg').style.display = 'inline-block'; deleteImageFlag = false; } }; reader.readAsDataURL(input.files[0]); } }
    window.markImageForDeletion = function() { document.getElementById('imgPreview').style.display = 'none'; document.getElementById('empPic').value = ''; document.getElementById('btnDeleteImg').style.display = 'none'; compressedImageBase64 = null; deleteImageFlag = true; }
    window.openReportModal = function() { const sidebarEl = document.getElementById('sidebarMenu'); const sidebarInstance = bootstrap.Offcanvas.getInstance(sidebarEl); if(sidebarInstance) sidebarInstance.hide(); const total = allData.length; document.getElementById('totalEmpCount').innerText = total; const deptCounts = {}; allData.forEach(e => { const d = e.Department || 'Unassigned'; deptCounts[d] = (deptCounts[d] || 0) + 1; }); const posCounts = {}; allData.forEach(e => { const p = e.Position || 'Unassigned'; posCounts[p] = (posCounts[p] || 0) + 1; }); renderReportList('deptReportList', deptCounts); renderReportList('posReportList', posCounts); new bootstrap.Modal(document.getElementById('reportModal')).show(); }
    window.renderReportList = function(elementId, countsObj) { const el = document.getElementById(elementId); el.innerHTML = ''; const sortedKeys = Object.keys(countsObj).sort(); sortedKeys.forEach(key => { el.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">${key}<span class="badge bg-primary rounded-pill">${countsObj[key]}</span></li>`; }); if(sortedKeys.length === 0) el.innerHTML = '<li class="list-group-item text-muted">No data available</li>'; }
    window.deleteEmployee = deleteEmployee;
    const toBase64 = file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
    function renderTable() { const tbody = document.getElementById('tableBody'); tbody.innerHTML = ''; const start = (currentPage - 1) * rowsPerPage; const pageData = filteredData.slice(start, start + rowsPerPage); pageData.forEach(row => { let picHtml = `<div class="profile-img-small d-flex justify-content-center align-items-center bg-secondary text-white" onclick="viewDetails(${row.row_index})"><i class="fas fa-user"></i></div>`; if (row['Profile Pic']) picHtml = `<img src="${row['Profile Pic']}" class="profile-img-small" onclick="viewDetails(${row.row_index})">`; let actions = `<button class="btn btn-info btn-sm me-1" onclick="viewDetails(${row.row_index})"><i class="fas fa-eye"></i></button>`; if (currentUser.role === 'Root') { actions += `<button class="btn btn-warning btn-sm me-1" onclick="openModal('edit', ${row.row_index})"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm" onclick="deleteEmployee(${row.row_index})"><i class="fas fa-trash"></i></button>`; } else if (currentUser.role === 'Admin' && row.Department === currentUser.department) { actions += `<button class="btn btn-warning btn-sm me-1" onclick="openModal('edit', ${row.row_index})"><i class="fas fa-edit"></i></button>`; } tbody.innerHTML += `<tr><td>${picHtml}</td><td>${row['Sr No.']}</td><td class="fw-bold">${row.Name}</td><td><span class="badge bg-secondary">${row.Position || '-'}</span></td><td><span class="badge bg-primary">${row.Department || '-'}</span></td><td>${row.Phone}</td><td>${actions}</td></tr>`; }); updatePaginationInfo(); }
    function loadEmployees() { showLoading(true); fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getEmployees' }) }).then(res => res.json()).then(resp => { showLoading(false); if(resp.status === 'success') { allData = resp.data; filterData(); }}); }
    function loadAllDropdowns() { fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getAllDropdowns' }) }).then(res => res.json()).then(resp => { if(resp.status === 'success') { dropdownData = resp.data; populateSelects(); }}); }
    function populateSelects() { populateSingleSelect('empDept', dropdownData['Department']); populateSingleSelect('empPos', dropdownData['Position']); populateSingleSelect('empBlood', dropdownData['Blood Type']); populateSingleSelect('empReligion', dropdownData['Religion']); }
    function populateSingleSelect(id, items) { const select = document.getElementById(id); select.innerHTML = `<option value="" selected disabled>Choose...</option>`; if(items) items.forEach(item => select.innerHTML += `<option value="${item}">${item}</option>`); }
    function deleteEmployee(rowIndex) { Swal.fire({ title: 'Delete?', text: "Action cannot be undone!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then((result) => { if (result.isConfirmed) { showLoading(true); fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteEmployee', rowIndex: rowIndex }) }).then(res => res.json()).then(data => { showLoading(false); loadEmployees(); }); } }); }
    function filterData() { const term = document.getElementById('searchInput').value.toLowerCase(); filteredData = allData.filter(i => i.Name.toLowerCase().includes(term) || (i.Department && i.Department.toLowerCase().includes(term)) || (i.Position && i.Position.toLowerCase().includes(term))); currentPage = 1; renderTable(); }
    function updatePaginationInfo() { const totalEntries = filteredData.length; const totalPages = Math.ceil(totalEntries / rowsPerPage) || 1; document.getElementById('pageInfo').innerText = `Showing ${(currentPage-1)*rowsPerPage + 1} to ${Math.min(currentPage*rowsPerPage, totalEntries)} of ${totalEntries}`; const ul = document.getElementById('pagination'); let html = `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Prev</a></li><li class="page-item"><input type="number" class="page-input-box" value="${currentPage}" min="1" max="${totalPages}" onchange="jumpToPage(this.value)"></li><li class="page-item disabled"><span class="page-link bg-white text-muted border-start-0">/ ${totalPages}</span></li><li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a></li>`; ul.innerHTML = html; }
    window.changePage = function(p) { if (p < 1 || p > Math.ceil(filteredData.length / rowsPerPage)) return; currentPage = p; renderTable(); }
    window.jumpToPage = function(val) { const pageNum = parseInt(val); const totalPages = Math.ceil(filteredData.length / rowsPerPage); if (pageNum >= 1 && pageNum <= totalPages) { currentPage = pageNum; } renderTable(); }
    window.changeRowsPerPage = function() { rowsPerPage = parseInt(document.getElementById('rowsPerPage').value); currentPage = 1; renderTable(); }
    function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
</script>

</body>
</html>
