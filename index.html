<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Poppins', sans-serif; }
        
        /* Initial State: Hide Everything */
        #loginPage, #mainPage { display: none; opacity: 0; transition: opacity 0.5s ease-in-out; }
        
        /* Fade In Effect */
        .fade-in-active { display: block !important; opacity: 1 !important; }

        .hidden { display: none !important; }
        
        /* Loading Screen (Always on top initially) */
        #appLoader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 99999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.5s ease;
        }

        /* Standard Loader Overlay */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 10000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }

        .profile-thumb { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .profile-preview { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 4px solid #0d6efd; margin-bottom: 15px; background: #eee; }
        .search-box { border-radius: 20px; }
        .page-link { cursor: pointer; user-select: none; }
    </style>
</head>
<body>

    <!-- 1. App Startup Loader (Shows immediately) -->
    <div id="appLoader">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <p class="mt-3 fw-bold text-secondary">Starting System...</p>
    </div>

    <!-- 2. Processing Overlay (For actions) -->
    <div id="actionLoader" class="loading-overlay hidden">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 fw-bold text-primary" id="loadingText">Processing...</p>
        <div class="progress w-25 mt-2 hidden" id="uploadProgressBox">
            <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%"></div>
        </div>
    </div>

    <!-- Login -->
    <div class="container mt-5" id="loginPage">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <div class="card shadow border-0 mt-5">
                    <div class="card-body p-5">
                        <div class="text-center mb-4"><h3 class="fw-bold text-primary">Login</h3></div>
                        <input type="text" id="loginUser" class="form-control mb-3" placeholder="Username">
                        <input type="password" id="loginPass" class="form-control mb-3" placeholder="Password" onkeyup="if(event.key==='Enter') doLogin()">
                        <button onclick="doLogin()" class="btn btn-primary w-100">Sign In</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="container-fluid" id="mainPage" style="max-width: 1400px;">
        <nav class="navbar navbar-dark bg-primary px-3 mb-4 shadow rounded-bottom">
            <span class="navbar-brand h1 m-0"><i class="bi bi-people-fill me-2"></i> Employee System</span>
            <div>
                <span id="roleBadge" class="badge bg-white text-primary me-2"></span>
                <button onclick="doLogout()" class="btn btn-sm btn-outline-light">Logout</button>
            </div>
        </nav>

        <div class="card shadow mb-4 border-0">
            <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="d-flex gap-2">
                    <input type="text" id="searchInput" class="form-control search-box" placeholder="Search..." onkeyup="filterData()">
                    <button onclick="exportToExcel()" class="btn btn-success btn-sm"><i class="bi bi-file-earmark-excel"></i> Export</button>
                </div>
                <button id="btnAdd" class="btn btn-primary btn-sm hidden" onclick="openModal('add')"><i class="bi bi-plus-lg"></i> Add New</button>
            </div>
        </div>

        <div class="card shadow border-0">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th class="ps-3">Img</th><th>ID</th><th>Name</th><th>Position</th><th>Phone</th><th class="text-end pe-3">Actions</th></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div id="noDataMsg" class="text-center text-muted mt-4 hidden">No records found</div>
                <hr>
                <div class="d-flex justify-content-between align-items-center">
                    <span id="pageInfo" class="small fw-bold text-muted ms-2"></span>
                    <ul class="pagination pagination-sm mb-0 me-2" id="paginationControls"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="dataModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white"><h5 class="modal-title" id="modalTitle">Employee Info</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-4">
                    <form id="empForm">
                        <input type="hidden" id="actionType"><input type="hidden" id="currentImage">
                        <div class="text-center mb-4"><img id="previewImg" src="https://via.placeholder.com/140" class="profile-preview shadow-sm"><br><label class="btn btn-sm btn-outline-primary rounded-pill px-4"><i class="bi bi-camera-fill me-2"></i> Select Photo<input type="file" id="fileInput" hidden accept="image/*" onchange="compressAndPreview(this)"></label><input type="hidden" id="base64Code"></div>
                        <div class="row g-3">
                            <div class="col-md-4"><label class="small text-muted">ID</label><input type="text" id="srNo" class="form-control"></div>
                            <div class="col-md-4"><label class="small text-muted">Name</label><input type="text" id="name" class="form-control"></div>
                            <div class="col-md-4"><label class="small text-muted">Position</label><input type="text" id="position" class="form-control"></div>
                            <div class="col-md-4"><label class="small text-muted">Phone</label><input type="text" id="phone" class="form-control"></div>
                            <div class="col-md-4"><label class="small text-muted">Email</label><input type="text" id="email" class="form-control"></div>
                            <div class="col-md-4"><label class="small text-muted">NRC</label><input type="text" id="nrc" class="form-control"></div>
                            <div class="col-12"><label class="small text-muted">Address</label><input type="text" id="address" class="form-control"></div>
                            <div class="col-md-4"><label class="small text-muted">Father</label><input type="text" id="fatherName" class="form-control"></div>
                            <div class="col-md-4"><label class="small text-muted">Mother</label><input type="text" id="motherName" class="form-control"></div>
                            <div class="col-md-4"><label class="small text-muted">Blood</label><input type="text" id="bloodType" class="form-control"></div>
                            <div class="col-md-4"><label class="small text-muted">Education</label><input type="text" id="education" class="form-control"></div>
                            <div class="col-md-4"><label class="small text-muted">Joined</label><input type="date" id="startDate" class="form-control"></div>
                            <div class="col-md-4"><label class="small text-muted">Resigned</label><input type="date" id="resignDate" class="form-control"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light"><button class="btn btn-light" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary px-4" onclick="submitData()">Save</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center p-4"><button class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button><img id="v_img" class="profile-preview mb-3"><h4 id="v_name" class="fw-bold"></h4><span id="v_pos" class="badge bg-primary rounded-pill mb-4"></span><div class="text-start table-responsive"><table class="table table-sm"><tbody id="viewBody"></tbody></table></div></div></div></div></div>
    <div class="modal fade" id="deleteModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">Confirm Delete</h5></div><div class="modal-body p-4 text-center"><p>Are you sure?</p></div><div class="modal-footer justify-content-center"><button class="btn btn-secondary" data-bs-dismiss="modal">No</button><button class="btn btn-danger" onclick="executeDelete()">Yes, Delete</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ********************************************
        // URL အသစ်ကို ဒီမှာ ထည့်ပါ
        // ********************************************
        const API_URL = "https://script.google.com/macros/s/AKfycby13c2f8jPvqi_3g05YzqZfHt3Hz2rdn-5RxinQQJRn1LUoq8R1WBXQVNAPWMTvZoSt/exec";

        let userRole="", globalData=[], filtered=[], currentPage=1, rowsPerPage=10;
        let deleteIndex=null;
        const SESSION_KEY = "ems_user_session"; 

        const getEl = id => document.getElementById(id);
        const toggleActionLoad = (s, txt="Processing...") => {
            getEl('actionLoader').classList.toggle('hidden', !s);
            getEl('loadingText').innerText = txt;
        };

        const apiCall = async (data) => {
            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify(data),
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    redirect: "follow"
                });
                return await response.json();
            } catch (error) { throw new Error("Connection Failed."); }
        };

        // --- 1. INITIALIZATION (NO FLICKER LOGIC) ---
        window.addEventListener('DOMContentLoaded', () => {
            const savedSession = localStorage.getItem(SESSION_KEY);
            const loader = getEl('appLoader');
            
            // Artificial delay to make it look smooth (500ms)
            setTimeout(() => {
                loader.style.opacity = '0'; // Fade out loader
                setTimeout(() => loader.style.display = 'none', 500); // Remove from DOM

                if(savedSession) {
                    // Logged In -> Fade In Dashboard
                    const session = JSON.parse(savedSession);
                    userRole = session.role;
                    getEl('mainPage').classList.add('fade-in-active');
                    setupDash();
                } else {
                    // Not Logged In -> Fade In Login
                    getEl('loginPage').classList.add('fade-in-active');
                }
            }, 500);
        });

        // --- AUTHENTICATION ---
        function doLogin() {
            const u=getEl('loginUser').value, p=getEl('loginPass').value;
            if(!u||!p) return alert("Enter credentials");
            toggleActionLoad(true, "Logging In...");
            
            apiCall({action:'login', username:u, password:p}).then(res => {
                toggleActionLoad(false);
                if(res.status) {
                    userRole = res.role;
                    localStorage.setItem(SESSION_KEY, JSON.stringify({ role: userRole }));
                    
                    // Smooth Transition to Dashboard
                    getEl('loginPage').classList.remove('fade-in-active');
                    setTimeout(() => {
                        getEl('loginPage').style.display = 'none'; // Ensure it's gone
                        getEl('mainPage').classList.add('fade-in-active');
                        setupDash();
                    }, 300);
                    
                } else alert(res.message);
            }).catch(e => { toggleActionLoad(false); alert(e.message); });
        }

        function doLogout() {
            localStorage.removeItem(SESSION_KEY);
            location.reload();
        }

        function setupDash() {
            getEl('roleBadge').innerText = userRole;
            if(userRole === 'Root') getEl('btnAdd').classList.remove('hidden');
            loadData();
        }

        function loadData() {
            // Background load, don't block UI unless empty
            if(globalData.length === 0) toggleActionLoad(true, "Loading Data...");
            apiCall({action:'read'}).then(res => {
                toggleActionLoad(false);
                if(res.status) { globalData = res.data; filtered = globalData; currentPage=1; renderTable(); }
            }).catch(e => toggleActionLoad(false));
        }

        // --- IMAGE COMPRESSION (Max 3MB Logic) ---
        function compressAndPreview(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Logic: If image is HUGE, resize significantly. If small, resize less.
                    let MAX_WIDTH = 800; 
                    if(file.size > 2 * 1024 * 1024) MAX_WIDTH = 600; // If > 2MB, shrink more
                    
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Compress Quality (0.6 is safe for 3MB limit)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6); 
                    
                    getEl('previewImg').src = dataUrl;
                    getEl('base64Code').value = dataUrl;
                }
            }
        }

        // --- TABLE ---
        function renderTable() {
            const tbody = getEl('tableBody'); tbody.innerHTML = "";
            const start = (currentPage-1)*rowsPerPage;
            const pageData = filtered.slice(start, start+rowsPerPage);
            if(filtered.length === 0) getEl('noDataMsg').classList.remove('hidden'); else getEl('noDataMsg').classList.add('hidden');

            pageData.forEach((r, idx) => {
                const img = r.profilePic || "https://via.placeholder.com/45?text=Img";
                const realIdx = start + idx; 
                let btns = `<button class="btn btn-info btn-sm me-1 rounded-circle text-white shadow-sm" onclick="openView(${realIdx})"><i class="bi bi-eye"></i></button>`;
                if(userRole==='Root') btns += `<button class="btn btn-warning btn-sm me-1 rounded-circle shadow-sm" onclick="openModal('edit', ${realIdx})"><i class="bi bi-pencil"></i></button><button class="btn btn-danger btn-sm rounded-circle shadow-sm" onclick="askDelete(${realIdx})"><i class="bi bi-trash"></i></button>`;
                else if(userRole==='Admin') btns += `<button class="btn btn-warning btn-sm rounded-circle shadow-sm" onclick="openModal('edit', ${realIdx})"><i class="bi bi-pencil"></i></button>`;
                tbody.innerHTML += `<tr><td class="ps-3"><img src="${img}" class="profile-thumb"></td><td class="fw-bold text-secondary">#${r.srNo}</td><td class="fw-bold">${r.name}</td><td>${r.position}</td><td>${r.phone}</td><td class="text-end pe-3">${btns}</td></tr>`;
            });
            renderPagination();
        }

        function renderPagination() {
            const total = Math.ceil(filtered.length/rowsPerPage);
            const ul = getEl('paginationControls'); ul.innerHTML = "";
            getEl('pageInfo').innerText = `Page ${currentPage} of ${total||1}`;
            if(total<=1) return;
            const addLi = (txt, p) => ul.innerHTML += `<li class="page-item ${currentPage===p?'active':''}"><button class="page-link" onclick="goToPage(${p})">${txt}</button></li>`;
            addLi("«", Math.max(1, currentPage-1));
            for(let i=1;i<=total;i++) if(i===1||i===total||(i>=currentPage-1&&i<=currentPage+1)) addLi(i,i);
            addLi("»", Math.min(total, currentPage+1));
        }
        function goToPage(p){currentPage=p; renderTable();}
        function changeRowsPerPage(){rowsPerPage=parseInt(getEl('rowsPerPage').value); currentPage=1; renderTable();}
        function filterData(){const t=getEl('searchInput').value.toLowerCase(); filtered=globalData.filter(x=>x.name.toLowerCase().includes(t)||x.srNo.toString().includes(t)); currentPage=1; renderTable();}

        // --- CRUD ---
        const dataModal = new bootstrap.Modal(getEl('dataModal'));
        function openModal(mode, idx=null) {
            getEl('actionType').value = mode; getEl('empForm').reset(); getEl('base64Code').value = "";
            getEl('modalTitle').innerText = mode==='add'?"Add Employee":"Update Info";
            if(mode==='edit') {
                const d = filtered[idx]; getEl('srNo').readOnly = true;
                ['srNo','name','position','phone','email','nrc','address','fatherName','motherName','bloodType','education','startDate','resignDate'].forEach(k => getEl(k).value = d[k]||"");
                getEl('currentImage').value = d.profilePic||""; getEl('previewImg').src = d.profilePic || "https://via.placeholder.com/150";
            } else {
                getEl('srNo').readOnly = false; getEl('currentImage').value = ""; getEl('previewImg').src = "https://via.placeholder.com/150?text=Upload";
            }
            dataModal.show();
        }

        function submitData() {
            const obj = { action: getEl('actionType').value, imageFile: getEl('base64Code').value, currentImage: getEl('currentImage').value };
            ['srNo','name','position','phone','email','nrc','address','fatherName','motherName','bloodType','education','startDate','resignDate'].forEach(k => obj[k] = getEl(k).value);
            toggleActionLoad(true, "Saving...");
            apiCall(obj).then(res => { toggleActionLoad(false); alert(res.message); if(res.status) { dataModal.hide(); loadData(); } }).catch(e => { toggleActionLoad(false); alert(e.message); });
        }

        const delModal = new bootstrap.Modal(getEl('deleteModal'));
        function askDelete(idx) { deleteIndex=idx; delModal.show(); }
        function executeDelete() {
            const d = filtered[deleteIndex]; delModal.hide(); toggleActionLoad(true, "Deleting...");
            apiCall({action:'delete', srNo:d.srNo}).then(res => { toggleActionLoad(false); alert(res.message); loadData(); });
        }

        const viewModal = new bootstrap.Modal(getEl('viewModal'));
        function openView(idx) {
            const d = filtered[idx]; getEl('v_img').src=d.profilePic||"https://via.placeholder.com/150"; getEl('v_name').innerText=d.name; getEl('v_pos').innerText=d.position;
            let h=""; const f={srNo:"ID",nrc:"NRC",phone:"Phone",email:"Email",address:"Addr",fatherName:"Father",motherName:"Mother",bloodType:"Blood",education:"Edu"};
            for(let k in f) h+=`<tr><td class="text-muted w-25">${f[k]}</td><td class="fw-bold">${d[k]}</td></tr>`;
            getEl('viewBody').innerHTML=h; viewModal.show();
        }
        function exportToExcel() { if(filtered.length===0) return alert("No data"); let c="data:text/csv;charset=utf-8,\uFEFF"+Object.keys(filtered[0]).join(",")+"\n"; filtered.forEach(r=>c+=Object.values(r).map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")+"\n"); const a=document.createElement('a'); a.href=encodeURI(c); a.download="employees.csv"; a.click(); }
    </script>
</body>
</html>
