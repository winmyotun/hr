<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Management System</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .btn { padding: 5px 10px; cursor: pointer; margin-right: 5px; }
        .btn-red { background-color: #ff4d4d; color: white; border: none; }
        .btn-blue { background-color: #007bff; color: white; border: none; }
        .btn-green { background-color: #28a745; color: white; border: none; }
        input { padding: 5px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; width: 400px; border-radius: 5px; }
    </style>
</head>
<body>

    <!-- Login Form -->
    <div id="loginSection">
        <h2>Login</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()" class="btn btn-blue">Login</button>
        <p id="loginError" style="color: red;"></p>
    </div>

    <!-- Dashboard -->
    <div id="dashboardSection" class="hidden">
        <h2>Employee List</h2>
        <p>Logged in as: <span id="displayRole" style="font-weight: bold;"></span></p>
        <button id="btnAdd" onclick="showAddModal()" class="btn btn-green hidden">Add New Employee</button>
        <button onclick="logout()" class="btn btn-red" style="float: right;">Logout</button>
        
        <table>
            <thead>
                <tr>
                    <th>Sr No.</th>
                    <th>Name</th>
                    <th>NRC No.</th>
                    <th>Position</th>
                    <th>Phone</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <!-- Modal for Add/Edit -->
    <div id="employeeModal" class="hidden modal">
        <div class="modal-content">
            <h3 id="modalTitle">Employee Info</h3>
            <input type="hidden" id="editRowIndex">
            <input type="text" id="srNo" placeholder="Sr No.">
            <input type="text" id="name" placeholder="Name">
            <input type="text" id="nrc" placeholder="NRC No.">
            <input type="text" id="address" placeholder="Address">
            <input type="text" id="phone" placeholder="Phone">
            <input type="text" id="email" placeholder="Email">
            <input type="text" id="father" placeholder="Father Name">
            <input type="text" id="mother" placeholder="Mother Name">
            <input type="text" id="blood" placeholder="Blood Type">
            <input type="text" id="edu" placeholder="Education">
            <input type="text" id="start" placeholder="Start Date">
            <input type="text" id="resign" placeholder="Resign Date">
            <input type="text" id="pos" placeholder="Position">
            <br><br>
            <button onclick="saveEmployee()" class="btn btn-green">Save</button>
            <button onclick="closeModal()" class="btn btn-red">Cancel</button>
        </div>
    </div>

    <script>
        // *** ဒီနေရာမှာ Web App URL ထည့်ပါ ***
        const API_URL = "https://script.google.com/macros/s/AKfycbx_x2Y-co6Mad5Q1FLeLQzWoGAXqe3-m8vbkZakCepB8rhH2kPsKiAJ6iUqamOvC5cG/exec"; 
        
        let currentUserRole = "";

        async function postData(action, data = {}) {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action, ...data })
            });
            return await response.json();
        }

        async function login() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            
            const res = await postData("login", { username: user, password: pass });
            
            if (res.status === "success") {
                currentUserRole = res.role;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                document.getElementById('displayRole').innerText = currentUserRole;
                
                // Root ဖြစ်မှ Add ခလုတ်ပြမယ်
                if (currentUserRole === "Root") {
                    document.getElementById('btnAdd').classList.remove('hidden');
                }
                loadEmployees();
            } else {
                document.getElementById('loginError').innerText = res.message;
            }
        }

        async function loadEmployees() {
            const res = await postData("read");
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";

            res.data.forEach(row => {
                const info = row.data;
                const rowIndex = row.rowIndex;
                // Header: Sr, Name, NRC, Address, Phone, Email, Father, Mother, Blood, Edu, Start, Resign, Position
                // Array Index: 0, 1, 2, ...
                
                let actionButtons = "";
                
                // Role အလိုက် Button တွေကို ထိန်းချုပ်ခြင်း
                if (currentUserRole === "Root" || currentUserRole === "Admin") {
                    // JSON stringify လုပ်ပြီး data တွေ pass လုပ်ပါမယ်
                    const rowDataStr = JSON.stringify(info).replace(/"/g, '&quot;');
                    actionButtons += `<button onclick="showEditModal(${rowIndex}, ${rowDataStr})" class="btn btn-blue">Edit</button>`;
                }
                if (currentUserRole === "Root") {
                    actionButtons += `<button onclick="deleteEmployee(${rowIndex})" class="btn btn-red">Delete</button>`;
                }

                // Table မှာ အရေးကြီးတဲ့ အချက်အလက်အချို့ပဲ ပြထားပါတယ် (Design ကျဉ်းလို့ပါ)
                const tr = `<tr>
                    <td>${info[0]}</td>
                    <td>${info[1]}</td>
                    <td>${info[2]}</td>
                    <td>${info[12]}</td>
                    <td>${info[4]}</td>
                    <td>${actionButtons}</td>
                </tr>`;
                tbody.innerHTML += tr;
            });
        }

        function showAddModal() {
            document.getElementById('modalTitle').innerText = "Add New Employee";
            document.getElementById('editRowIndex').value = ""; // Clear Index
            clearInputs();
            document.getElementById('employeeModal').classList.remove('hidden');
        }

        function showEditModal(rowIndex, data) {
            document.getElementById('modalTitle').innerText = "Edit Employee";
            document.getElementById('editRowIndex').value = rowIndex;
            
            // Fill Inputs
            const ids = ['srNo', 'name', 'nrc', 'address', 'phone', 'email', 'father', 'mother', 'blood', 'edu', 'start', 'resign', 'pos'];
            ids.forEach((id, index) => {
                document.getElementById(id).value = data[index] || "";
            });

            document.getElementById('employeeModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('employeeModal').classList.add('hidden');
        }

        function clearInputs() {
            const ids = ['srNo', 'name', 'nrc', 'address', 'phone', 'email', 'father', 'mother', 'blood', 'edu', 'start', 'resign', 'pos'];
            ids.forEach(id => document.getElementById(id).value = "");
        }

        async function saveEmployee() {
            const rowIndex = document.getElementById('editRowIndex').value;
            const ids = ['srNo', 'name', 'nrc', 'address', 'phone', 'email', 'father', 'mother', 'blood', 'edu', 'start', 'resign', 'pos'];
            const data = ids.map(id => document.getElementById(id).value);

            if (rowIndex) {
                // Edit Mode
                await postData("edit", { data: data, rowIndex: rowIndex });
            } else {
                // Add Mode
                await postData("add", { data: data });
            }
            closeModal();
            loadEmployees();
        }

        async function deleteEmployee(rowIndex) {
            if (confirm("Are you sure you want to delete?")) {
                await postData("delete", { rowIndex: rowIndex });
                loadEmployees();
            }
        }

        function logout() {
            location.reload();
        }
    </script>
</body>
</html>
