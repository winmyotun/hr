<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee CRUD System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background-color: #28a745; color: white; border: none; }
        button:hover { background-color: #218838; }
        button.delete { background-color: #dc3545; }
        button.edit { background-color: #ffc107; color: black; }
        button.view { background-color: #17a2b8; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #333; color: white; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 5px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .control-group { display: flex; gap: 10px; }
        .profile-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; }
    </style>
</head>
<body>

<div class="container" id="loginSection">
    <h2>Login</h2>
    <input type="text" id="loginUsername" placeholder="Username">
    <input type="password" id="loginPassword" placeholder="Password">
    <button onclick="login()">Login</button>
</div>

<div class="container hidden" id="dashboardSection">
    <div style="display:flex; justify-content:space-between;">
        <h2>Employee Management <span id="userRoleDisplay" style="font-size:14px; color:gray;"></span></h2>
        <button onclick="logout()" style="width:auto; background-color: #666;">Logout</button>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <button id="btnAdd" onclick="openModal('add')" style="width:auto;">+ Add New</button>
            <button onclick="exportTableToExcel('employeeTable', 'employees_data')" style="width:auto; background-color:#2c3e50;">Export Excel</button>
        </div>
        <div class="control-group">
            <select id="rowsPerPage" onchange="changeRowsPerPage()" style="width:auto;">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
            <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Search..." style="width:200px;">
        </div>
    </div>

    <table id="employeeTable">
        <thead>
            <tr>
                <th>Sr No.</th>
                <th>Image</th>
                <th>Name</th>
                <th>Position</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- Data will be populated here -->
        </tbody>
    </table>
    <div id="paginationInfo" style="margin-top:10px;"></div>
</div>

<!-- Modal for Add/Edit/View -->
<div id="dataModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle">Employee Details</h3>
        <form id="employeeForm" onsubmit="event.preventDefault(); saveEmployee();">
            <input type="hidden" id="empId">
            <input type="text" id="empName" placeholder="Name" required>
            <input type="text" id="empNrc" placeholder="NRC No.">
            <input type="text" id="empAddress" placeholder="Address">
            <input type="text" id="empPhone" placeholder="Phone">
            <input type="email" id="empEmail" placeholder="Email">
            <div style="display:flex; gap:10px;">
                <input type="text" id="empFather" placeholder="Father Name">
                <input type="text" id="empMother" placeholder="Mother Name">
            </div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="empBlood" placeholder="Blood Type">
                <input type="text" id="empEdu" placeholder="Education">
            </div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="empStart" placeholder="Start Date" onfocus="(this.type='date')">
                <input type="text" id="empResign" placeholder="Resign Date" onfocus="(this.type='date')">
            </div>
            <input type="text" id="empPosition" placeholder="Position">
            <label>Profile Pic:</label>
            <input type="file" id="empPic" accept="image/*">
            
            <div id="formActions" style="margin-top:15px;">
                <button type="submit" id="btnSave">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyBQIrDFq_Da1vUi0RPu2RG1q1EO1PMUWHierk201IhTf-AMA1RP9pDtHZVY5ofOyUZg/exec'; // ဒီနေရာမှာ Web App URL ထည့်ပါ
    let currentUserRole = '';
    let employeesData = [];
    let currentPage = 1;
    let rowsPerPage = 10;

    // Enter Key to Login
    document.getElementById("loginPassword").addEventListener("keypress", function(event) {
        if (event.key === "Enter") login();
    });

    async function apiCall(action, data = {}) {
        document.body.style.cursor = 'wait';
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors', // Important for cross-origin
            body: JSON.stringify({ action: action, ...data })
        });
        document.body.style.cursor = 'default';
        return await response.json();
    }

    async function login() {
        const user = document.getElementById('loginUsername').value;
        const pass = document.getElementById('loginPassword').value;
        const res = await apiCall('login', { username: user, password: pass });

        if (res.status === 'success') {
            currentUserRole = res.role;
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('userRoleDisplay').innerText = `(${currentUserRole})`;
            setupPermissions();
            loadEmployees();
        } else {
            alert(res.message);
        }
    }

    function logout() {
        location.reload();
    }

    function setupPermissions() {
        const btnAdd = document.getElementById('btnAdd');
        if (currentUserRole === 'Root') {
            btnAdd.style.display = 'block';
        } else {
            btnAdd.style.display = 'none';
        }
    }

    async function loadEmployees() {
        const res = await apiCall('getEmployees');
        if (res.status === 'success') {
            employeesData = res.data;
            renderTable();
        }
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        // Filter
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filteredData = employeesData.filter(row => 
            row.some(val => String(val).toLowerCase().includes(searchTerm))
        );

        // Pagination
        const start = (currentPage - 1) * rowsPerPage;
        const paginatedData = filteredData.slice(start, start + parseInt(rowsPerPage));

        paginatedData.forEach(emp => {
            const tr = document.createElement('tr');
            // Assuming emp array structure matches sheet columns
            // 0:Sr, 1:Name, ... 13:PicUrl
            let actionButtons = `<button class="view" onclick='viewDetails(${JSON.stringify(emp)})'>View</button> `;
            
            if (currentUserRole === 'Root' || currentUserRole === 'Admin') {
                actionButtons += `<button class="edit" onclick='openModal("edit", ${JSON.stringify(emp)})'>Edit</button> `;
            }
            if (currentUserRole === 'Root') {
                actionButtons += `<button class="delete" onclick="deleteEmp(${emp[0]})">Delete</button>`;
            }

            tr.innerHTML = `
                <td>${emp[0]}</td>
                <td>${emp[13] ? `<img src="${emp[13]}" class="profile-thumb">` : '-'}</td>
                <td>${emp[1]}</td>
                <td>${emp[12]}</td>
                <td>${emp[4]}</td>
                <td>${emp[5]}</td>
                <td style="white-space:nowrap;">${actionButtons}</td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('paginationInfo').innerText = `Showing ${paginatedData.length} of ${filteredData.length} entries`;
    }

    function changeRowsPerPage() {
        rowsPerPage = document.getElementById('rowsPerPage').value;
        currentPage = 1;
        renderTable();
    }

    function searchTable() {
        currentPage = 1;
        renderTable();
    }

    let currentMode = '';
    
    function openModal(mode, emp = null) {
        currentMode = mode;
        document.getElementById('dataModal').style.display = 'block';
        const form = document.getElementById('employeeForm');
        form.reset();
        
        const inputs = form.querySelectorAll('input');
        inputs.forEach(input => input.disabled = (mode === 'view'));
        document.getElementById('btnSave').style.display = (mode === 'view') ? 'none' : 'block';

        if (mode === 'add') {
            document.getElementById('modalTitle').innerText = "Add New Employee";
        } else {
            document.getElementById('modalTitle').innerText = mode === 'edit' ? "Edit Employee" : "View Details";
            document.getElementById('empId').value = emp[0];
            document.getElementById('empName').value = emp[1];
            document.getElementById('empNrc').value = emp[2];
            document.getElementById('empAddress').value = emp[3];
            document.getElementById('empPhone').value = emp[4];
            document.getElementById('empEmail').value = emp[5];
            document.getElementById('empFather').value = emp[6];
            document.getElementById('empMother').value = emp[7];
            document.getElementById('empBlood').value = emp[8];
            document.getElementById('empEdu').value = emp[9];
            // Fix date format if needed
            document.getElementById('empStart').value = emp[10] ? new Date(emp[10]).toISOString().split('T')[0] : '';
            document.getElementById('empResign').value = emp[11] ? new Date(emp[11]).toISOString().split('T')[0] : '';
            document.getElementById('empPosition').value = emp[12];
        }
    }

    function viewDetails(emp) {
        openModal('view', emp);
    }

    function closeModal() {
        document.getElementById('dataModal').style.display = 'none';
    }

    async function saveEmployee() {
        const fileInput = document.getElementById('empPic');
        let base64 = "";
        
        if (fileInput.files.length > 0) {
            base64 = await toBase64(fileInput.files[0]);
        }

        const data = {
            srNo: document.getElementById('empId').value,
            name: document.getElementById('empName').value,
            nrc: document.getElementById('empNrc').value,
            address: document.getElementById('empAddress').value,
            phone: document.getElementById('empPhone').value,
            email: document.getElementById('empEmail').value,
            fatherName: document.getElementById('empFather').value,
            motherName: document.getElementById('empMother').value,
            bloodType: document.getElementById('empBlood').value,
            education: document.getElementById('empEdu').value,
            startDate: document.getElementById('empStart').value,
            resignDate: document.getElementById('empResign').value,
            position: document.getElementById('empPosition').value,
            profilePicBase64: base64
        };

        let action = currentMode === 'add' ? 'addEmployee' : 'editEmployee';
        const res = await apiCall(action, { data: data });
        
        alert(res.message);
        closeModal();
        loadEmployees();
    }

    async function deleteEmp(id) {
        if (confirm("Are you sure you want to delete this employee? This cannot be undone.")) {
            const res = await apiCall('deleteEmployee', { id: id });
            alert(res.message);
            loadEmployees();
        }
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    function exportTableToExcel(tableID, filename = ''){
        var downloadLink;
        var dataType = 'application/vnd.ms-excel';
        var tableSelect = document.getElementById(tableID);
        var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
        
        filename = filename?filename+'.xls':'excel_data.xls';
        downloadLink = document.createElement("a");
        document.body.appendChild(downloadLink);
        
        if(navigator.msSaveOrOpenBlob){
            var blob = new Blob(['\ufeff', tableHTML], {
                type: dataType
            });
            navigator.msSaveOrOpenBlob( blob, filename);
        }else{
            downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
            downloadLink.download = filename;
            downloadLink.click();
        }
    }

    // Close modal if outside click
    window.onclick = function(event) {
        if (event.target == document.getElementById('dataModal')) {
            closeModal();
        }
    }
</script>

</body>
</html>
